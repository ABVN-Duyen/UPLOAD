sap.ui.define(["sap/ui/core/mvc/Controller","jquery.sap.global","sap/m/MessageToast","sap/ui/model/odata/ODataModel","sap/m/MessageBox"],function(e,t,a,s,o){"use strict";var n=[];var r=[];var i="sapUiResponsivePadding--header sapUiResponsivePadding--content sapUiResponsivePadding--footer";var l=e.extend("ZHTS.ZHTS.controller.Upload",{handleUploadComplete:function(e){var t=e.getParameter("response");if(t){t=t.split(">")[1];t=t.substring(0,t.length-5);a.show(t);console.log(t)}},handleUploadExcel:function(e){var a=this.byId("itemsTable2");var s=this.getView().byId("fileUploader2");var o=t.sap.domById(s.getId()+"-fu").files[0];var n=new FileReader;n.readAsBinaryString(o);n.onload=function(e){var t=e.target.result;var s=XLSX.read(t,{type:"binary"});var o={};var n={};var r=[];s.SheetNames.forEach(function(e){r.push(e);var t=XLSX.utils.sheet_to_row_object_array(s.Sheets[e]);if(t.length>0){o[e]=t;n[e]=Object.keys(t[0])}if(t.length>0){o=t;n=Object.keys(t[0])}});var i=new sap.ui.model.json.JSONModel;i.setData(o);a.setModel(i);console.log(o);return o}.bind(this)},handleUploadPress:function(e){var s=this.byId("itemsTable");var o=this.byId("itemsTable2");var n=this.getView().byId("fileUploader");const r=this;if(!n.getValue()){a.show("Choose a file first");return}else{function d(e,t=","){const a=e.slice(0,e.indexOf("\n")).split(t);const s=e.slice(e.indexOf("\n")+1).split("\n");const o=s.map(function(e){const s=e.split(t);const o=a.reduce(function(e,t,a){e[t]=s[a];return e},{});console.log(o);return o});return o}function u(e){const t=new Object;const a=[];const s=[];const o=[];const n=Object.keys(e[0]);console.log(n);for(let t=0;t<e.length;t++){const o=new Object;for(let a=0;a<n.length;a++){const r=new Object;switch(n[a]){case"Variable":o.VAR=e[t][n[a]];break;case"Names of variable":o.VAR_NAME=e[t][n[a]];break;case"Variable number":o.VAR_NO=e[t][n[a]];break;case"Major Classification":o.MAJ_CLASS=e[t][n[a]];break;case"Minor classification":o.MIN_CLASS=e[t][n[a]];break;case"Data Source Flag: SCT":o.DS_SCT=e[t][n[a]];break;case"Data Source Flag: Manual":o.DS_MANUAL=e[t][n[a]];break;case"Direction to aim for":o.DIRECTION=e[t][n[a]];break;case"Staggered years (Overview)":o.STAGG_YEAR_MATRIX=e[t][n[a]];break;case"Staggered years (VRC)":o.STAGG_YEAR_VRC=e[t][n[a]];break;case"Staggered year exclusion flag":o.EXCL_FLAG=e[t][n[a]];break;case"Relevant Flag for Overview Analysis":o.FLAG_MATRIX=e[t][n[a]];break;case"Relevant Flag for VRC":o.FLAG_VRC=e[t][n[a]];break;case"Start period (Year)":o.PERIOD_START=e[t][n[a]];break;case"End period (Year)":o.PERIOD_END=e[t][n[a]];break;case"Item No.":o.VAR_ITM_NO=e[t][n[a]];break;case"Item":o.VAR_ITM_NAME=e[t][n[a]];break;case"SCT API - Entity name":o.SCT_ENTITY=e[t][n[a]];break;case"SCT API - Measure field name":o.MEASURE_ID=e[t][n[a]];break;case"SCT API - Filter dimension ID":o.DIM_ID=e[t][n[a]];break;case"SCT API - Filter value":o.DIM_VAL=e[t][n[a]];break;default:if(e[t]["Variable"]!=undefined&&e[t]["Variable"]!=null){r.VAR=e[t]["Variable"].replace("\r","")}if(n[a]!=undefined&&n[a]!=null){r.YEAR=n[a].replace("\r","")}if(e[t][n[a]]!=undefined&&e[t][n[a]]!=null){r.VALUE=e[t][n[a]].replace("\r","")}r.STATUS="sap-icon://status-critical";if(r.VALUE!=""){s.push(r)}}}o.STATUS="sap-icon://status-critical";a.push(o)}return[a,s]}var i=t.sap.domById(n.getId()+"-fu").files[0];var l=new FileReader;var c="jsonObject=";l.onload=function(e){var t=e.target.result.replace("ï»¿","");console.log(t);var n=d(t);var i=t.match(/[\w \: \( \) \- .]+(?=,?)/g);var l=33;console.log(i);var c=i.splice(0,l);var g=[];while(i.length>0){var p={};var v=i.splice(0,l);for(var h=0;h<v.length;h++){p[c[h]]=v[h].trim()}p.STATUS="sap-icon://status-critical";console.log(p);g.push(p)}var f=new sap.ui.model.json.JSONModel;var S=new sap.ui.model.json.JSONModel;n.forEach((e,t,a)=>{if(e.Variable==undefined||!e.Variable||e.Variable==""){n.splice(t,1)}});const[A,T]=u(n);f.setData(A);s.setModel(f);let b=r.getView().getModel().getData();S.setData(T);o.setModel(S);let E=new sap.ui.model.json.JSONModel({error:false});r.getView().setModel(E,"oModelSCT");let I=o.mAggregations.items;I.map(e=>{let t=e.mAggregations.cells[3].getId();let s=parseFloat(e.mAggregations.cells[3].mProperties.value);if(isNaN(s)){r.getView().byId(t).addStyleClass("error");r.getView().getModel("oModelSCT").setProperty("/error",true);a.show("Invalid Transaction Data!")}else{r.getView().byId(t).removeStyleClass("error")}})};l.readAsText(i)}},handleUploadPress2:function(e){var s=this.byId("itemsTable2");var o=this.getView().byId("fileUploader2");if(!o.getValue()){a.show("Choose a file first");return}else{function l(e,t=","){const a=e.slice(0,e.indexOf("\n")).split(t);const s=e.slice(e.indexOf("\n")+1).split("\n");const o=s.map(function(e){const s=e.split(t);const o=a.reduce(function(e,t,a){e[t]=s[a];return e},{});return o});return o}var n=t.sap.domById(o.getId()+"-fu").files[0];var r=new FileReader;var i="jsonObject=";r.onload=function(e){var t=e.target.result;var a=l(t);var o=t.match(/[\w .]+(?=,?)/g);var n=3;var r=o.splice(0,n);var i=[];while(o.length>0){var c={};var d=o.splice(0,n);for(var u=0;u<d.length;u++){c[r[u]]=d[u].trim()}c.STATUS="sap-icon://status-critical";i.push(c)}var g=new sap.ui.model.json.JSONModel;g.setData(i);s.setModel(g);console.log(a)};r.readAsBinaryString(n)}},handleSubmit:function(e){var t=this;o.warning("Current data will be deleted and upload new. Proceed to upload? ",{icon:o.Icon.WARNING,title:"Warning",actions:[o.Action.OK,o.Action.CANCEL],onClose:function(e){if(e=="OK"){t.handleSubmitPress()}},emphasizedAction:o.Action.OK,initialFocus:o.Action.CANCEL,styleClass:i})},handleSubmitPress:function(e){let t=this.getView().getModel("oModelSCT").getProperty("/error");if(t==true){a.show("Please set up your data correctly before submit!")}else{var s=this.byId("itemsTable");var o=s.getModel();var n=o.getData();var i=[];var l=n.length;let e=this.getView();e.setBusy(true);r=[];for(var c=0;c<l;c++){var d={};d.VAR=n[c].VAR;d.VAR_NAME=n[c].VAR_NAME;d.VAR_NO=parseInt(n[c].VAR_NO);d.VAR_ITM_NO=parseInt(n[c].VAR_ITM_NO);d.VAR_ITM_NAME=n[c].VAR_ITM_NAME;d.DIRECTION=n[c].DIRECTION;d.EXCL_FLAG=n[c].EXCL_FLAG;d.MAJ_CLASS=n[c].MAJ_CLASS;d.MIN_CLASS=n[c].MIN_CLASS;d.SCT_ENTITY=n[c].SCT_ENTITY;d.MEASURE_ID=n[c].MEASURE_ID;d.DIM_ID=n[c].DIM_ID;d.DIM_VAL=n[c].DIM_VAL;d.DS_SCT=n[c].DS_SCT;d.DS_MANUAL=n[c].DS_MANUAL;if(n[c].STAGG_YEAR_MATRIX==""){d.STAGG_YEAR_MATRIX=0}else{d.STAGG_YEAR_MATRIX=parseInt(n[c].STAGG_YEAR_MATRIX)}if(n[c].STAGG_YEAR_VRC==""){d.STAGG_YEAR_VRC=0}else{d.STAGG_YEAR_VRC=parseInt(n[c].STAGG_YEAR_VRC)}d.FLAG_MATRIX=n[c].FLAG_MATRIX;d.FLAG_VRC=n[c].FLAG_VRC;d.PERIOD_START=n[c].PERIOD_START;d.PERIOD_END=n[c].PERIOD_END;r.push(d)}$.ajax({url:"/catalog/delete_header()",type:"GET",method:"GET",success:function(e,t,a){console.log("success delete header")}.bind(this),error:function(e){console.log(e)}.bind(this)});$.ajax({url:"/catalog/ESG_MEASURE_MASTER",type:"GET",beforeSend:function(e){e.setRequestHeader("X-Requested-With","XMLHttpRequest");e.setRequestHeader("Content-Type","application/atom+xml");e.setRequestHeader("DataServiceVersion","2.0");e.setRequestHeader("X-CSRF-Token","Fetch")},success:function(e,t,a){var o=a.getResponseHeader("X-CSRF-Token");let n;if(o!=null||o!=undefined){n={"X-CSRF-Token":o,"Content-Type":"application/json"}}else{n={"Content-Type":"application/json"}}let l=Object.assign([],r);$.ajax({type:"POST",url:"/catalog/upload_header",data:JSON.stringify({uploadHeader:l}),headers:n,cache:false,success:function(e,t,a){console.log("success header");for(var o=0;o<r.length;o++){r[o].STATUS="sap-icon://status-positive";i.push(r[o])}var n=new sap.ui.model.json.JSONModel;n.setData(i);s.setModel(n)}.bind(this),error:function(e){console.log(e)}.bind(this)})}});let t=[];r.map(e=>{if(e.DS_SCT=="X"){t.push(e.VAR)}});this.handleSubmitPress2(e,t)}},handleSubmitPress2:function(e,t){var a=this.byId("itemsTable2");var s=a.getModel();var r=s.getData();var i=[];var l=r.length;n=[];for(var c=0;c<r.length;c++){if(r[c].VALUE==""){var d=parseFloat("0").toFixed(14)}else{var d=parseFloat(r[c].VALUE).toFixed(14)}n.push({VAR:r[c].VAR,YEAR:r[c].YEAR,VALUE:d})}let u=n;for(let e=0;e<t.length;e++){u=u.filter(a=>a.VAR!=t[e])}$.ajax({url:"/catalog/delete_item()",type:"GET",method:"GET",success:function(e,t,a){console.log("success item header")}.bind(this),error:function(e){console.log(e)}.bind(this)});$.ajax({url:"/catalog/DB_ESG_MANUAL_TRANS",type:"GET",beforeSend:function(e){e.setRequestHeader("X-Requested-With","XMLHttpRequest");e.setRequestHeader("Content-Type","application/atom+xml");e.setRequestHeader("DataServiceVersion","2.0");e.setRequestHeader("X-CSRF-Token","Fetch")},success:function(t,s,r){var l=r.getResponseHeader("X-CSRF-Token");let c;if(l!=null||l!=undefined){c={"X-CSRF-Token":l,"Content-Type":"application/json"}}else{c={"Content-Type":"application/json"}}let d=Object.assign([],u);$.ajax({type:"POST",url:"/catalog/upload_item",data:JSON.stringify({uploadItem:d}),headers:c,cache:false,success:function(t,s,r){console.log("success item");for(var l=0;l<n.length;l++){u.map(e=>{if(e.VAR==n[l].VAR){n[l].STATUS="sap-icon://status-positive"}})}n.map(e=>{if(e.STATUS==undefined){e.STATUS="sap-icon://alert"}});i=n;var c=new sap.ui.model.json.JSONModel;c.setData(i);a.setModel(c);e.setBusy(false);o.show("Success",{title:"Upload Completed"})}.bind(this),error:function(e){console.log(e)}.bind(this)})}})},handleSavePress:function(e){var t=this.getView().byId("bar11");var a=t.getSelectedKey();if(a.match("filter0")){var s=this.byId("itemsTable");var o=s.getSelectedItem();var n=s.indexOfItem(o);var r=s.getModel();var i=r.getData();var l=[];var c=n;var d={};d.VAR=i[c].VAR;d.YEARS=parseInt(i[c].YEARS);d.NAME=i[c].NAME;d.EXP_VAR=parseInt(i[c].EXP_VAR);d.ITEM=parseInt(i[c].ITEM);d.ITEM_DES=i[c].ITEM_DES;d.DIREC=i[c].DIREC;d.EXCLU=i[c].EXCLU;var u=`/catalog/Header`;var g="/catalog/Header(VAR='"+d.VAR+"')";console.log("abc");$.ajax({url:g,headers:{"Content-Type":"application/json"},type:"DELETE",method:"DELETE",success:function(e,t,a){console.log(e);console.log("success");i.splice(n,1);r.setData(i);s.setModel(r);r.refresh()}.bind(this),error:function(e){console.log(e);console.log(JSON.stringify(d));d.STATUS="sap-icon://status-positive"}.bind(this)});console.log("abc");$.ajax({url:u,data:JSON.stringify(d),headers:{"Content-Type":"application/json"},type:"POST",method:"POST",success:function(e,t,a){console.log(e);console.log("success")}.bind(this),error:function(e){console.log(e);console.log(JSON.stringify(d));d.STATUS="sap-icon://status-negative"}.bind(this)});i[c].STATUS="sap-icon://status-positive";r.setData(i);var p=s.getSelectedItem();var v=p.getCells();$(v).each(function(e){var t=v[e];var a=t.getMetadata();var s=a.getElementName();if(s=="sap.m.Input"){t.setEditable(false)}});r.refresh()}else{var s=this.byId("itemsTable2");var o=s.getSelectedItem();var n=s.indexOfItem(o);var r=s.getModel();var i=r.getData();var l=[];var c=n;var d={};d.VAR=i[c].VAR;d.YEARS=parseInt(i[c].YEARS);d.VALUE=i[c].VALUE;var u=`/catalog/Items`;var g="/catalog/Items(VAR='"+d.VAR+"',YEARS="+d.YEARS+")";console.log("abc");$.ajax({url:g,headers:{"Content-Type":"application/json"},type:"DELETE",method:"DELETE",success:function(e,t,a){console.log(e);console.log("success")}.bind(this),error:function(e){console.log(e);console.log(JSON.stringify(d));d.STATUS="sap-icon://status-positive"}.bind(this)});console.log("abc");$.ajax({url:u,data:JSON.stringify(d),headers:{"Content-Type":"application/json"},type:"POST",method:"POST",success:function(e,t,a){console.log(e);console.log("success")}.bind(this),error:function(e){console.log(e);console.log(JSON.stringify(d));d.STATUS="sap-icon://status-negative"}.bind(this)});console.log("abc");i[c].STATUS="sap-icon://status-positive";r.setData(i);var p=s.getSelectedItem();var v=p.getCells();$(v).each(function(e){var t=v[e];var a=t.getMetadata();var s=a.getElementName();if(s=="sap.m.Input"){t.setEditable(false)}});r.refresh()}},handleRetrievePress:function(e){var t=this.getView().byId("bar11");var s=t.getSelectedKey();if(s.match("filter0")){var o=this.byId("itemsTable");var n=`/catalog/Header`;var r=[];$.ajax({type:"GET",method:"GET",url:n,success:function(e,t,a){console.log(e);var s=e.value;var n=new sap.ui.model.json.JSONModel;n.setData(s);o.setModel(n);n.refresh();this.getView().byId("filter0").setCount(s.length)}.bind(this),error:function(e){console.log(e);console.log(JSON.stringify(oEntry))}.bind(this)})}else{var o=this.byId("itemsTable2");var n=`/catalog/Items`;var r=[];$.ajax({type:"GET",method:"GET",url:n,success:function(e,t,a){console.log(e);var s=e.value;var n=new sap.ui.model.json.JSONModel;n.setData(s);o.setModel(n);n.refresh();this.getView().byId("filter1").setCount(s.length)}.bind(this),error:function(e){console.log(e);console.log(JSON.stringify(oEntry))}.bind(this)})}a.show("Data was retrieved")},handleAddPress:function(e){var t=this.getView().byId("bar11");var s=t.getSelectedKey();if(s.match("filter0")){var o=this.byId("itemsTable")}else{var o=this.byId("itemsTable2")}var n=o.getItems()[0];var r=n.getCells();var i=o.getModel();var l=i.getData();var c={};c.STATUS="sap-icon://user-edit";l.unshift(c);i.setData(l);o.setModel(i);$(r).each(function(e){var t=r[e];var a=t.getMetadata();var s=a.getElementName();if(s=="sap.m.Input"){t.setEditable(true)}});i.refresh();a.show("Data was added")},handleEditPress:function(e){var t=this.getView().byId("bar11");var s=t.getSelectedKey();if(s.match("filter0")){var o=this.byId("itemsTable")}else{var o=this.byId("itemsTable2")}var n=o.getSelectedItem();var r=n.getCells();var i=o.getModel();var l=i.getData();i.setData(l);o.setModel(i);$(r).each(function(e){var t=r[e];var a=t.getMetadata();var s=a.getElementName();if(s=="sap.m.Input"){t.setEditable(true)}});i.refresh();a.show("Data can be edited now")},handleDeletePress:function(e){var t=this.getView().byId("bar11");var s=t.getSelectedKey();if(s.match("filter0")){var o=this.byId("itemsTable");var n=o.getModel();var r=n.getData();var o=this.getView().byId("itemsTable");var i=o.getSelectedItem();var l=o.indexOfItem(i);if(l!==-1){n.setData(r);o.setModel(n);var c={};c.VAR=r[l].VAR;c.YEARS=parseInt(r[l].YEARS);c.NAME=r[l].NAME;c.EXP_VAR=parseInt(r[l].EXP_VAR);c.ITEM=parseInt(r[l].ITEM);c.ITEM_DES=r[l].ITEM_DES;c.DIREC=r[l].DIREC;c.EXCLU=r[l].EXCLU;var d="/catalog/Header(VAR='"+c.VAR+"')";console.log("abc");$.ajax({url:d,headers:{"Content-Type":"application/json"},type:"DELETE",method:"DELETE",success:function(e,t,a){console.log(e);console.log("success");r.splice(l,1);n.setData(r);o.setModel(n);n.refresh();this.getView().byId("filter0").setCount(r.length)}.bind(this),error:function(e){console.log(e);console.log(JSON.stringify(c));c.STATUS="sap-icon://status-positive"}.bind(this)});a.show("Item was deleted")}else{a.show("No Items Selected. Please Select an Item")}}else{var o=this.byId("itemsTable2");var n=o.getModel();var r=n.getData();var o=this.getView().byId("itemsTable2");var i=o.getSelectedItem();var l=o.indexOfItem(i);if(l!==-1){n.setData(r);o.setModel(n);var c={};c.VAR=r[l].VAR;c.YEARS=parseInt(r[l].YEARS);var d="/catalog/Items(VAR='"+c.VAR+"',YEARS="+c.YEARS+")";console.log("abc");$.ajax({url:d,headers:{"Content-Type":"application/json"},type:"DELETE",method:"DELETE",success:function(e,t,a){console.log(e);console.log("success");r.splice(l,1);n.setData(r);o.setModel(n);n.refresh();this.getView().byId("filter1").setCount(r.length)}.bind(this),error:function(e){console.log(e);console.log(JSON.stringify(c));c.STATUS="sap-icon://status-positive"}.bind(this)});a.show("Item was deleted")}else{a.show("No Items Selected. Please Select an Item")}}},handleTypeMissmatch:function(e){var s=e.getSource().getFileType();t.each(s,function(e,t){s[e]="*."+t});var o=s.join(", ");a.show("The file type *."+e.getParameter("fileType")+" is not supported. Choose one of the following types: "+o)},handleValueChange:function(e){this.handleUploadPress()},doNavBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("home",true)},onSelectTab:function(e){var t=e.mParameters.key;var a=e.getSource();var s=this;console.log(t)}});return l});